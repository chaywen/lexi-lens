<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Reading Assistant</title>
<style>
  body { font-family: sans-serif; margin:0; display:flex; height:100vh; }
  .main-layout { display:flex; flex:1; }
  .camera-panel { flex:1; background:#222; display:flex; justify-content:center; align-items:center; position:relative; }
  video { width:100%; height:100%; object-fit:cover; border-radius:12px; }
  .right-panel { width:400px; background:#f5f5f5; display:flex; flex-direction:column; padding:10px; box-sizing:border-box; }
  .text-display { flex:1; overflow-y:auto; border:1px solid #ccc; padding:10px; border-radius:8px; }
  .chat-history { height:120px; overflow-y:auto; border-top:1px solid #ccc; margin-top:10px; padding:5px; }
  .control-bar { margin-top:10px; display:flex; gap:5px; }
  .active-word { background:yellow; transition: background 0.3s; }
  button { padding:6px 10px; border:none; border-radius:6px; cursor:pointer; }
</style>
</head>
<body>
<div class="main-layout">
  <div class="camera-panel">
    <video id="camera" autoplay muted></video>
    <button id="snapshot-btn" style="position:absolute;bottom:10px;right:10px;">Snapshot</button>
  </div>
  <div class="right-panel">
    <div class="text-display" id="text-display">Loading...</div>
    <div class="chat-history" id="chat-history"></div>
    <div class="control-bar">
      <button id="mic-btn">üé§ Mic</button>
      <button id="upload-btn">üìÅ Upload</button>
      <input type="file" id="file-input" style="display:none;">
      <button id="font-increase">A+</button>
      <button id="font-decrease">A-</button>
    </div>
  </div>
</div>

<script>
const CONFIG = { WS_URL:'wss://your-backend.example/ws', API_URL:'https://your-backend.example', MAX_FILE_SIZE: 10*1024*1024 };
const SESSION_TOKEN = crypto.randomUUID();
let ws;

// -------------------- WebSocket --------------------
function initWebSocket() {
  ws = new WebSocket(CONFIG.WS_URL);
  ws.onopen = () => console.log('WS connected');
  ws.onmessage = e => handleWSMessage(JSON.parse(e.data));
  ws.onclose = () => setTimeout(initWebSocket, 2000); // reconnect
}

function sendMessage(type, payload={}) {
  if (!ws || ws.readyState !== WebSocket.OPEN) return;
  ws.send(JSON.stringify({ type, session_token: SESSION_TOKEN, ...payload }));
}

function handleWSMessage(msg) {
  if(msg.type === 'highlight') highlightWord(msg.word_index);
  else if(msg.type === 'chat') addChat('ai', msg.text);
}

// -------------------- Camera --------------------
const video = document.getElementById('camera');
navigator.mediaDevices.getUserMedia({video:true})
  .then(stream => video.srcObject = stream)
  .catch(console.error);

document.getElementById('snapshot-btn').addEventListener('click', takeSnapshot);

function takeSnapshot() {
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video,0,0);
  const dataURL = canvas.toDataURL('image/png');
  sendMessage('snapshot', { frame: dataURL });
}

// -------------------- Mic --------------------
let recorder, audioChunks=[];
const micBtn = document.getElementById('mic-btn');
micBtn.addEventListener('click', toggleMic);

async function toggleMic() {
  if(recorder && recorder.state==='recording'){ recorder.stop(); return; }
  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  recorder = new MediaRecorder(stream);
  recorder.ondataavailable = e => {
    if(e.data.size>0){
      e.arrayBuffer().then(buf=>{
        const base64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
        sendMessage('audio_chunk',{ audio: base64 });
      });
    }
  };
  recorder.start();
}

// -------------------- Chat History --------------------
function addChat(role,text){
  const div = document.createElement('div');
  div.textContent = `${role==='user'?'You':'AI'}: ${text}`;
  document.getElementById('chat-history').appendChild(div);
  document.getElementById('chat-history').scrollTop = document.getElementById('chat-history').scrollHeight;
}

// -------------------- File Upload --------------------
const uploadBtn = document.getElementById('upload-btn');
const fileInput = document.getElementById('file-input');
uploadBtn.addEventListener('click',()=>fileInput.click());
fileInput.addEventListener('change', handleUpload);

async function handleUpload(e){
  const file = e.target.files[0];
  if(!file) return;
  if(!['application/pdf','image/png','image/jpeg','image/webp'].includes(file.type)){
    alert('Invalid file type'); return;
  }
  if(file.size>CONFIG.MAX_FILE_SIZE){ alert('File too large'); return; }

  const formData = new FormData();
  formData.append('file',file);
  try {
    const resp = await fetch(`${CONFIG.API_URL}/api/upload`, {method:'POST', body:formData});
    if(!resp.ok) throw new Error('Upload failed');
    const data = await resp.json();
    renderTextMock(data.words || mockWords());
  } catch(err){ console.error(err); alert('Upload failed'); }
}

// -------------------- Word Rendering & Highlight --------------------
const textDisplay = document.getElementById('text-display');

function renderTextMock(words){
  textDisplay.innerHTML = '';
  words.forEach((w,i)=>{
    const span = document.createElement('span');
    span.textContent = w + ' ';
    span.dataset.wordIndex = i;
    textDisplay.appendChild(span);
  });
}

function highlightWord(index){
  textDisplay.querySelectorAll('span').forEach(s=>s.classList.remove('active-word'));
  const span = textDisplay.querySelector(`span[data-word-index="${index}"]`);
  if(span){
    span.classList.add('active-word');
    span.scrollIntoView({behavior:'smooth', block:'center'});
  }
}

// Mock words for testing
function mockWords(){ return 'This is a sample text for highlighting demo.'.split(' '); }

// -------------------- Font Size --------------------
let fontSize = 16;
document.getElementById('font-increase').addEventListener('click',()=>{ fontSize+=2; textDisplay.style.fontSize=fontSize+'px'; });
document.getElementById('font-decrease').addEventListener('click',()=>{ fontSize=Math.max(10,fontSize-2); textDisplay.style.fontSize=fontSize+'px'; });

// -------------------- Init --------------------
initWebSocket();
renderTextMock(mockWords());
</script>
</body>
</html>
