<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LexiLens UI Test</title>
<style>
  /* ===== Body ===== */
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background: #f4f6f8;
    color: #1f2933;
  }
  #app {
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* ===== Main Layout ===== */
  .main-layout {
    flex: 1;
    display: grid;
    grid-template-columns: 1fr 1.5fr;
    gap: 20px;
    padding: 20px;
    box-sizing: border-box;
  }

  /* ===== Camera ===== */
  .camera-container {
    background: #000;
    border-radius: 16px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    max-height: 300px;
  }
  #video {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  /* ===== Right Panel ===== */
  .right-panel {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .text-display {
    flex: 1;
    background: white;
    border-radius: 14px;
    padding: 20px;
    font-size: 20px;
    line-height: 1.6;
    overflow-y: auto;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  }

  .chat-history {
    height: 180px;
    background: white;
    border-radius: 14px;
    padding: 15px;
    overflow-y: auto;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  }

  .chat-message {
    margin-bottom: 8px;
  }
  .chat-message.ai {
    color: #0f766e;
  }
  .chat-message.user {
    color: #334155;
  }

  /* Uploaded Files */
  #uploaded-files {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }
  .uploaded-file img {
    max-height: 50px;
    margin-left: 5px;
    border-radius: 6px;
  }

  /* Action Buttons */
  .action-buttons {
    display: flex;
    gap: 10px;
  }
  .action-buttons button {
    flex: 1;
    padding: 12px;
    border-radius: 10px;
    border: none;
    font-size: 16px;
    cursor: pointer;
    background: #117a65;
    color: white;
    transition: 0.2s;
  }
  .action-buttons button:hover {
    background: #0e6655;
  }

  /* Bottom Control Bar */
  .control-bar {
    display: flex;
    gap: 15px;
    padding: 15px 20px;
    background: white;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
  }
  .control-bar button {
    padding: 10px 16px;
    border-radius: 10px;
    border: none;
    font-size: 16px;
    cursor: pointer;
    background: #e2e8f0;
  }
  .control-bar button:hover {
    background: #cbd5e1;
  }
  .mock-btn {
    background: #117a65 !important;
    color: white !important;
  }
</style>
</head>
<body>
<div id="app">
  <div class="main-layout">
    <!-- Camera -->
    <div class="camera-container">
      <video id="video" autoplay muted></video>
    </div>

    <!-- Right Panel -->
    <div class="right-panel">
      <div id="reading-text" class="text-display">Text will appear here...</div>
      <div id="chat-history" class="chat-history"></div>
      <div id="uploaded-files"></div>
      <div class="action-buttons">
        <button id="explain-btn">Explain Simply</button>
        <button id="stop-btn">Stop Reading</button>
      </div>
    </div>
  </div>

  <!-- Bottom Control Bar -->
  <div class="control-bar">
    <button id="mic-btn">ðŸŽ™ Mic</button>
    <button id="snapshot-btn">ðŸ“¸ Snapshot</button>
    <button id="upload-btn">ðŸ“„ Upload</button>
    <input type="file" id="file-input" style="display:none">
    <button id="mock-btn" class="mock-btn">Play Mock</button>
    <button id="font-increase">A+</button>
    <button id="font-decrease">A-</button>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const CONFIG = {
  WS_URL: "ws://localhost:8080/ws/session",
  API_URL: "http://localhost:8080"
};

/* ===== STATE ===== */
let isRecording = false;
let mediaRecorder = null;
let videoStream = null;

/* ===== DOMContentLoaded ===== */
window.addEventListener("DOMContentLoaded", () => {
  initCamera();
  setupEvents();
});

/* ===== CAMERA ===== */
async function initCamera() {
  try {
    videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
    document.getElementById("video").srcObject = videoStream;
  } catch (err) {
    console.error("Camera error:", err);
  }
}

/* ===== EVENTS ===== */
function setupEvents() {
  document.getElementById("mic-btn").addEventListener("click", toggleMic);
  document.getElementById("snapshot-btn").addEventListener("click", takeSnapshot);
  document.getElementById("upload-btn").addEventListener("click", () =>
    document.getElementById("file-input").click()
  );
  document.getElementById("mock-btn").addEventListener("click", playMock);
  document.getElementById("stop-btn").addEventListener("click", stopSpeech);
  document.getElementById("explain-btn").addEventListener("click", explainSimply);

  document.getElementById("font-increase")?.addEventListener("click", increaseFont);
  document.getElementById("font-decrease")?.addEventListener("click", decreaseFont);

  document.getElementById("file-input").addEventListener("change", handleUpload);
}

/* ===== MIC ===== */
async function toggleMic() {
  if (!isRecording) {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.start();
    isRecording = true;
    addChat("Listening...", "user");
  } else {
    mediaRecorder.stop();
    isRecording = false;
  }
}

/* ===== SNAPSHOT ===== */
function takeSnapshot() {
  const video = document.getElementById("video");
  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0);
  addChat("Snapshot captured.", "ai");
}

/* ===== MOCK VOICE ===== */
function playMock() {
  const msg = "Hello. I am Lexi. I will read this text for you.";
  speak(msg);
  addChat(msg, "ai");
}

/* ===== SPEECH ===== */
function speak(text) {
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 0.9;
  u.pitch = 1;
  speechSynthesis.speak(u);
}

function stopSpeech() {
  speechSynthesis.cancel();
}

/* ===== EXPLAIN SIMPLY ===== */
function explainSimply() {
  const msg = "Here is a simpler explanation of the text.";
  speak(msg);
  addChat(msg, "ai");
}

/* ===== CHAT ===== */
function addChat(text, sender) {
  const chatArea = document.getElementById("chat-history");
  const div = document.createElement("div");
  div.className = `chat-message ${sender}`;
  div.textContent = text;
  chatArea.appendChild(div);
  chatArea.scrollTop = chatArea.scrollHeight;
}

/* ===== FONT CONTROL ===== */
function increaseFont() {
  const el = document.getElementById("reading-text");
  let size = parseFloat(window.getComputedStyle(el).fontSize);
  el.style.fontSize = size + 2 + "px";
}

function decreaseFont() {
  const el = document.getElementById("reading-text");
  let size = parseFloat(window.getComputedStyle(el).fontSize);
  if (size > 16) el.style.fontSize = size - 2 + "px";
}

/* ===== FILE UPLOAD ===== */
function handleUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  const allowed = ['application/pdf','image/png','image/jpeg','image/webp'];
  if (!allowed.includes(file.type)) {
    alert("Only PDF/PNG/JPG/WEBP allowed");
    return;
  }

  const uploadedArea = document.getElementById("uploaded-files");
  const div = document.createElement("div");
  div.className = "uploaded-file";
  div.textContent = `Uploaded: ${file.name}`;
  uploadedArea.appendChild(div);

  if (file.type.startsWith("image/")) {
    const img = document.createElement("img");
    img.src = URL.createObjectURL(file);
    div.appendChild(img);
  }
}
</script>
</body>
</html>
