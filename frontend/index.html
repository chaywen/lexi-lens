<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LexiLens Phase 2 Mock Test</title>
<style>
body { margin:0;font-family:'Inter',sans-serif;background:#f4f6f8;color:#1f2933; }
.main-layout { display:grid; grid-template-columns:1.3fr 1fr; gap:20px; padding:20px; height:100vh; box-sizing:border-box;}
.camera-inner { background: rgba(0,0,0,0.6); border-radius:24px; padding:12px; height:100%; position:relative; display:flex; justify-content:center; align-items:center; }
#video { width:100%; height:100%; object-fit:cover; border-radius:20px; }
.camera-overlay { position:absolute; bottom:15px; left:15px; display:flex; gap:10px; }
.btn { padding:10px 14px; border-radius:16px; border:none; cursor:pointer; background:#5b4fff; color:white; }
.right-panel { display:flex; flex-direction:column; gap:20px; }
.text-display { background:#fff7e6; border-radius:16px; padding:20px; font-size:18px; flex:1; overflow-y:auto; }
.chat-history { background:white; border-radius:16px; padding:15px; flex:1; overflow-y:auto; }
.chat-message { padding:10px; margin-bottom:8px; border-radius:12px; max-width:70%; }
.chat-message.ai { background:#d8b4fe; }
.chat-message.user { background:#4b5563; color:white; margin-left:auto; }
.control-bar { display:flex; gap:10px; }
.btn-outline { padding:8px 12px; border-radius:12px; border:1px solid #ccc; background:white; cursor:pointer; }
.active-word { background: #ffd54f; }
</style>
</head>
<body>

<div class="main-layout">

  <!-- Camera Card -->
  <div class="camera-card">
    <div class="camera-inner">
      <video id="video" autoplay muted playsinline></video>
      <div class="camera-overlay">
        <button id="mic-btn" class="btn">ðŸŽ™ Mic</button>
        <button id="snapshot-btn" class="btn">ðŸ“¸ Snapshot</button>
        <button id="upload-btn" class="btn">ðŸ“„ Upload</button>
        <input type="file" id="file-input" hidden>
      </div>
    </div>
  </div>

  <!-- Right Panel -->
  <div class="right-panel">

    <div class="text-display" id="reading-text">
      <p>The recognized text will appear here.</p>
    </div>

    <div class="chat-history" id="chat-history">
      <div class="chat-message ai">
        Lexi: Hello! I am ready to read for you.
      </div>
    </div>

    <div class="control-bar">
      <button id="explain-btn" class="btn-outline">Explain Simply</button>
      <button id="stop-btn" class="btn-outline">Stop Reading</button>
      <button id="test-voice-btn" class="btn-outline">ðŸ”Š Test Voice</button>
      <button id="font-increase" class="btn-outline">A+</button>
      <button id="font-decrease" class="btn-outline">A-</button>
    </div>

  </div>
</div>

<script>
// =====================
// Mock WebSocket for local testing
// =====================
let wsMock = {
  send: (msg) => {
    console.log("Mock WS send:", msg);
    // æ¨¡æ‹ŸæœåŠ¡å™¨å“åº”é«˜äº®
    setTimeout(() => {
      const data = JSON.parse(msg);
      if(data.type === "snapshot") addChat("Server: Snapshot received.", "ai");
      else if(data.type === "upload") addChat(`Server: File "${data.name}" processed.`, "ai");
    },500);
  }
};
function sendMessage(type, payload) {
  wsMock.send(JSON.stringify({type, session_token:"mock_token_123", ...payload}));
}

// =====================
// Camera
// =====================
navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => { document.getElementById("video").srcObject = stream; })
  .catch(err => console.error(err));

document.getElementById("snapshot-btn").addEventListener("click", () => {
  const video = document.getElementById("video");
  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video,0,0);
  const frame = canvas.toDataURL("image/png");
  sendMessage("snapshot", {frame});
  addChat("Snapshot sent", "user");
});

// =====================
// File Upload
// =====================
document.getElementById("upload-btn").addEventListener("click", () => document.getElementById("file-input").click());
document.getElementById("file-input").addEventListener("change", (e) => {
  const file = e.target.files[0];
  if(!file) return;
  const allowed = ["image/png","image/jpeg","image/webp","application/pdf"];
  if(!allowed.includes(file.type)) { alert("Unsupported file type"); return; }
  if(file.size > 10*1024*1024) { alert("File too large"); return; }
  sendMessage("upload", {name:file.name, size:file.size, type:file.type});
  addChat(`Uploaded ${file.name}`, "user");
});

// =====================
// Speech Recognition
// =====================
let recognition;
let isRecording = false;

function initSpeechRecognition() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SpeechRecognition) { alert("Speech Recognition not supported. Use Chrome."); return; }
  recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.onresult = function(event) {
    let transcript = "";
    for(let i=event.resultIndex;i<event.results.length;i++)
      transcript += event.results[i][0].transcript;
    document.getElementById("reading-text").innerText = transcript;
  };
}
initSpeechRecognition();

document.getElementById("mic-btn").addEventListener("click", () => {
  if(!isRecording){ recognition.start(); isRecording=true; addChat("Listening...","user"); }
  else { recognition.stop(); isRecording=false; }
});

// =====================
// Chat
// =====================
function addChat(text, sender) {
  const chat = document.getElementById("chat-history");
  const div = document.createElement("div");
  div.className = "chat-message " + sender;
  div.innerText = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

// =====================
// Font Control
// =====================
document.getElementById("font-increase").addEventListener("click", () => {
  const el = document.getElementById("reading-text");
  let size = parseFloat(window.getComputedStyle(el).fontSize);
  el.style.fontSize = (size+2)+"px";
});
document.getElementById("font-decrease").addEventListener("click", () => {
  const el = document.getElementById("reading-text");
  let size = parseFloat(window.getComputedStyle(el).fontSize);
  if(size>16) el.style.fontSize=(size-2)+"px";
});

// =====================
// Control Bar Buttons
// =====================
document.getElementById("explain-btn").addEventListener("click", () => addChat("Explain Simply clicked", "user"));
document.getElementById("stop-btn").addEventListener("click", () => addChat("Stop Reading clicked", "user"));
document.getElementById("test-voice-btn").addEventListener("click", ()=>{
  const msg = "Hello, I am Lexi.";
  const utter = new SpeechSynthesisUtterance(msg);
  utter.rate = 0.9;
  speechSynthesis.speak(utter);
  addChat(msg, "ai");
});

// =====================
// Mock Highlighter
// =====================
let mockWords = ["This","is","a","mock","text","for","highlighting","test","phase","2"];
function renderMockText() {
  const container = document.getElementById("reading-text");
  container.innerHTML = "";
  mockWords.forEach((w,i)=>{
    const span = document.createElement("span");
    span.innerText = w + " ";
    span.dataset.wordIndex = i;
    container.appendChild(span);
  });
}
renderMockText();

let currentWord = 0;
setInterval(()=>{
  document.querySelectorAll("#reading-text span").forEach(s=>s.classList.remove("active-word"));
  const span = document.querySelector(`#reading-text span[data-word-index='${currentWord}']`);
  if(span) span.classList.add("active-word");
  currentWord = (currentWord+1)%mockWords.length;
},1000);
</script>

</body>
</html>
